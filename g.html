<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>PlayLinks Game</title>
    <style>
      body { font-family: system-ui; max-width: 720px; margin: 40px auto; padding: 0 16px; }
      .card { border: 1px solid #ddd; border-radius: 14px; padding: 16px; margin: 12px 0; }
      button { padding: 12px 14px; border-radius: 12px; border: 1px solid #111; background: #111; color: #fff; cursor: pointer; }
      button.secondary { background: #fff; color: #111; }
      button:disabled { opacity: 0.5; cursor: not-allowed; }
      .muted { color: #666; }
      .big { font-size: 22px; }
      code { background: #f5f5f5; padding: 2px 6px; border-radius: 6px; }
      .row { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; margin-top: 10px; }
    </style>
  </head>
  <body>
    <h1 id="title">Loading‚Ä¶</h1>
    <p class="muted">Game ID: <code id="gid"></code></p>

    <div class="card">
      <p id="main" class="big">Opening‚Ä¶</p>
      <p id="sub" class="muted"></p>
      <div class="row">
        <button id="passBtn">üîÅ Pass it now</button>
        <button id="refresh" class="secondary">Refresh</button>
      </div>
    </div>

    <script>
      const API = "https://api.playlinks.games";
      const params = new URLSearchParams(location.search);
      const gameId = params.get("g");
      const token = params.get("t"); // pass_token embedded in link

      const gidEl = document.getElementById("gid");
      const titleEl = document.getElementById("title");
      const mainEl = document.getElementById("main");
      const subEl = document.getElementById("sub");
      const passBtn = document.getElementById("passBtn");

      gidEl.textContent = gameId || "(missing)";

      function getHolderId() {
        const key = "playlinks_holder_id";
        let v = localStorage.getItem(key);
        if (!v) {
          v = "h_" + Math.random().toString(36).slice(2) + Date.now().toString(36);
          localStorage.setItem(key, v);
        }
        return v;
      }

      let countdownTimer = null;

      function formatRemaining(ms) {
        const s = Math.max(0, Math.floor(ms / 1000));
        const hh = Math.floor(s / 3600);
        const mm = Math.floor((s % 3600) / 60);
        const ss = s % 60;
        return `${hh}h ${mm}m ${ss}s`;
      }

      function startCountdown(expiresAt, hopCount) {
        if (countdownTimer) clearInterval(countdownTimer);

        function tick() {
          const left = expiresAt - Date.now();
          if (left <= 0) {
            subEl.textContent = `Passes: ${hopCount} ‚Ä¢ ‚è≥ Ending‚Ä¶`;
            clearInterval(countdownTimer);
            countdownTimer = null;
            refresh();
            return;
          }
          subEl.textContent = `Passes: ${hopCount} ‚Ä¢ ‚è≥ Ends in ${formatRemaining(left)}`;
        }

        tick();
        countdownTimer = setInterval(tick, 1000);
      }

      function showExpiredResult({ youAreHolderAtEnd, hopCount }) {
        titleEl.textContent = "Game over";
        passBtn.disabled = true;

        if (youAreHolderAtEnd) {
          mainEl.textContent = "üî• You got burned. You were holding it at the end.";
          subEl.textContent = `Damn. Pass it earlier next time üòà ‚Ä¢ Total passes: ${hopCount ?? "‚Äî"}`;
        } else {
          mainEl.textContent = "üòÆ‚Äçüí® You survived. Someone else got burned.";
          subEl.textContent = `Curiosity satisfied. Run it again? ‚Ä¢ Total passes: ${hopCount ?? "‚Äî"}`;
        }
      }

      function showStaleLink() {
        // Someone opened an old link after a pass happened
        titleEl.textContent = "Hot Potato";
        mainEl.textContent = "‚è≥ This link is old.";
        subEl.textContent = "You need the latest story link to claim the potato.";
        passBtn.disabled = true;
      }

      async function claim() {
        if (!gameId || !token) {
          titleEl.textContent = "Invalid link";
          mainEl.textContent = "Missing game id or token.";
          subEl.textContent = "Ask the person who shared it to repost the latest link.";
          passBtn.disabled = true;
          return;
        }

        const holderId = getHolderId();

        const res = await fetch(`${API}/game/${gameId}/claim`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ holderId, token }),
        });

        let data = {};
        try { data = await res.json(); } catch {}

        if (!data.ok) {
          titleEl.textContent = "Error";
          mainEl.textContent = "Could not load game.";
          subEl.textContent = data.error || "unknown_error";
          passBtn.disabled = true;
          return;
        }

        if (data.expired) {
          showExpiredResult({ youAreHolderAtEnd: !!data.youWin, hopCount: data.hopCount });
          return;
        }

        if (data.stale) {
          showStaleLink();
          return;
        }

        titleEl.textContent = "Hot Potato";
        mainEl.textContent = "üî• You are holding it right now.";
        passBtn.disabled = false;
        startCountdown(data.expiresAt, data.hopCount);
      }

      async function refresh() {
        if (!gameId) return;

        const holderId = getHolderId();
        const res = await fetch(`${API}/game/${gameId}/status?holderId=${encodeURIComponent(holderId)}`);

        let data = {};
        try { data = await res.json(); } catch {}

        if (!data.ok) return;

        if (data.expired) {
          showExpiredResult({ youAreHolderAtEnd: !!data.youHold, hopCount: data.hopCount });
          return;
        }

        titleEl.textContent = "Hot Potato";
        mainEl.textContent = data.youHold ? "üî• You are holding it right now." : "üòÆ Someone else is holding it.";
        passBtn.disabled = !data.youHold;
        startCountdown(data.expiresAt, data.hopCount);
      }

      async function passItNow() {
        const holderId = getHolderId();
        passBtn.disabled = true;

        const res = await fetch(`${API}/game/${gameId}/pass`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ holderId }),
        });

        let data = {};
        try { data = await res.json(); } catch {}

        if (!data.ok) {
          passBtn.disabled = false;
          subEl.textContent = data.error === "not_holder"
            ? "You can only pass if you‚Äôre the current holder."
            : "Pass failed. Try again.";
          return;
        }

        if (data.expired) {
          showExpiredResult({ youAreHolderAtEnd: true, hopCount: data.hopCount });
          return;
        }

        const newLink = data.url;

        // Best-effort 2-in-1 share flow:
        // 1) Try native share sheet (works on most phones)
        // 2) Always fall back to copy
        let shared = false;
        if (navigator.share) {
          try {
            await navigator.share({ title: "Hot Potato", text: "You‚Äôre holding it‚Ä¶ pass it üî•", url: newLink });
            shared = true;
          } catch {}
        }

        try {
          await navigator.clipboard.writeText(newLink);
          if (shared) {
            subEl.textContent = `‚úÖ Shared + copied. Total passes: ${data.hopCount}`;
          } else {
            subEl.textContent =
              `‚úÖ New link copied. Post it to your IG Story to pass it. ‚Ä¢ Total passes: ${data.hopCount}`;
          }
        } catch {
          subEl.textContent =
            "Couldn‚Äôt auto-copy. Manually copy the new link from the address bar after it updates.";
        }

        // Update the current page URL to the new token (so refresh doesn't become stale)
        const newUrl = new URL(location.href);
        newUrl.searchParams.set("t", new URL(newLink).searchParams.get("t"));
        history.replaceState({}, "", newUrl.toString());

        // Refresh status/UI
        await claim();
      }

      document.getElementById("refresh").onclick = refresh;
      passBtn.onclick = passItNow;

      claim();
    </script>
  </body>
</html>
