<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>PlayLinks Game</title>
    <style>
      body {
        font-family: system-ui;
        max-width: 720px;
        margin: 40px auto;
        padding: 0 16px;
      }
      .card {
        border: 1px solid #ddd;
        border-radius: 14px;
        padding: 16px;
        margin: 12px 0;
      }
      button {
        padding: 12px 14px;
        border-radius: 12px;
        border: 1px solid #111;
        background: #111;
        color: #fff;
        cursor: pointer;
      }
      button.secondary {
        background: #fff;
        color: #111;
      }
      .muted {
        color: #666;
      }
      .big {
        font-size: 22px;
      }
      code {
        background: #f5f5f5;
        padding: 2px 6px;
        border-radius: 6px;
      }
      .row {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        align-items: center;
        margin-top: 10px;
      }
    </style>
  </head>
  <body>
    <h1 id="title">Loading‚Ä¶</h1>
    <p class="muted">Game ID: <code id="gid"></code></p>

    <div class="card">
      <p id="main" class="big">Opening‚Ä¶</p>
      <p id="sub" class="muted"></p>

      <div class="row">
        <button id="share">üîÅ Pass it now</button>
        <button id="refresh" class="secondary">Refresh</button>
      </div>
    </div>

    <script>
      const API = "https://api.playlinks.games";
      const params = new URLSearchParams(location.search);
      const gameId = params.get("g");

      const gidEl = document.getElementById("gid");
      const titleEl = document.getElementById("title");
      const mainEl = document.getElementById("main");
      const subEl = document.getElementById("sub");

      gidEl.textContent = gameId || "(missing)";

      // ----------------------------
      // Holder identity (anonymous)
      // ----------------------------
      function getHolderId() {
        const key = "playlinks_holder_id";
        let v = localStorage.getItem(key);
        if (!v) {
          v =
            "h_" +
            Math.random().toString(36).slice(2) +
            Date.now().toString(36);
          localStorage.setItem(key, v);
        }
        return v;
      }

      // ----------------------------
      // Countdown (Update #1)
      // ----------------------------
      let countdownTimer = null;

      function formatRemaining(ms) {
        const s = Math.max(0, Math.floor(ms / 1000));
        const hh = Math.floor(s / 3600);
        const mm = Math.floor((s % 3600) / 60);
        const ss = s % 60;
        return `${hh}h ${mm}m ${ss}s`;
      }

      function startCountdown(expiresAt, hopCount) {
        if (countdownTimer) clearInterval(countdownTimer);

        function tick() {
          const left = expiresAt - Date.now();
          if (left <= 0) {
            subEl.textContent = `Hops: ${hopCount} ‚Ä¢ ‚è≥ Ending‚Ä¶`;
            clearInterval(countdownTimer);
            countdownTimer = null;
            // Auto-refresh to show result screen
            refresh();
            return;
          }
          subEl.textContent = `Hops: ${hopCount} ‚Ä¢ ‚è≥ Ends in ${formatRemaining(left)}`;
        }

        tick();
        countdownTimer = setInterval(tick, 1000);
      }

      // ----------------------------
      // Result UI (Update #3 + #4)
      // ----------------------------
      function showExpiredResult({ youAreHolderAtEnd, hopCount }) {
        titleEl.textContent = "Game over";

        if (youAreHolderAtEnd) {
          mainEl.textContent = "üî• You got burned. You were holding it at the end.";
          subEl.textContent = `Damn. Pass it earlier next time üòà ‚Ä¢ Total passes: ${hopCount ?? "‚Äî"}`;
        } else {
          mainEl.textContent = "üòÆ‚Äçüí® You survived. Someone else got burned.";
          subEl.textContent = `Curiosity satisfied. Run it again? ‚Ä¢ Total passes: ${hopCount ?? "‚Äî"}`;
        }
      }

      // ----------------------------
      // Claim (auto-hold on open)
      // ----------------------------
      async function claim() {
        if (!gameId) {
          titleEl.textContent = "Invalid link";
          mainEl.textContent = "Missing game id.";
          subEl.textContent = "This link is incomplete.";
          return;
        }

        const holderId = getHolderId();

        const res = await fetch(`${API}/game/${gameId}/claim`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ holderId }),
        });

        let data = {};
        try {
          data = await res.json();
        } catch {
          titleEl.textContent = "Error";
          mainEl.textContent = "Bad response from server.";
          subEl.textContent = "Try again in a moment.";
          return;
        }

        if (!data.ok) {
          titleEl.textContent = "Error";
          mainEl.textContent = "Could not load game.";
          subEl.textContent = data.error || "unknown_error";
          return;
        }

        if (data.expired) {
          // Backend returns: { expired: true, youWin: boolean, hopCount?: number }
          showExpiredResult({
            youAreHolderAtEnd: !!data.youWin,
            hopCount: data.hopCount,
          });
          return;
        }

        titleEl.textContent = "Hot Potato";
        mainEl.textContent = "üî• You are holding it right now.";
        startCountdown(data.expiresAt, data.hopCount);
      }

      // ----------------------------
      // Refresh status
      // ----------------------------
      async function refresh() {
        if (!gameId) return;

        const holderId = getHolderId();
        const res = await fetch(
          `${API}/game/${gameId}/status?holderId=${encodeURIComponent(holderId)}`
        );

        let data = {};
        try {
          data = await res.json();
        } catch {
          return;
        }

        if (!data.ok) return;

        if (data.expired) {
          // Backend returns: { expired: true, youHold: boolean, hopCount: number }
          showExpiredResult({
            youAreHolderAtEnd: !!data.youHold,
            hopCount: data.hopCount,
          });
          return;
        }

        titleEl.textContent = "Hot Potato";
        mainEl.textContent = data.youHold
          ? "üî• You are holding it right now."
          : "üòÆ Someone else is holding it.";

        startCountdown(data.expiresAt, data.hopCount);
      }

      // ----------------------------
      // Pass it UX (Update #2)
      // ----------------------------
      document.getElementById("share").onclick = async () => {
        const link = location.href;
        try {
          await navigator.clipboard.writeText(link);
          subEl.textContent =
            "‚úÖ Link copied. Instagram ‚Üí Story ‚Üí Paste (or Link sticker) to pass it.";
        } catch {
          subEl.textContent =
            "Copy failed ‚Äî manually copy the URL from the address bar.";
        }
      };

      document.getElementById("refresh").onclick = refresh;

      // Kick off
      claim();
    </script>
  </body>
</html>
