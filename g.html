function json(data, status = 200, extraHeaders = {}) {
  return new Response(JSON.stringify(data), {
    status,
    headers: {
      "Content-Type": "application/json",
      ...extraHeaders,
    },
  });
}

function corsHeaders(origin) {
  const allowed = new Set([
    "https://playlinks.games",
    "https://www.playlinks.games",
  ]);
  const o = allowed.has(origin) ? origin : "https://playlinks.games";

  return {
    "Access-Control-Allow-Origin": o,
    "Access-Control-Allow-Methods": "GET,POST,OPTIONS",
    "Access-Control-Allow-Headers": "Content-Type",
  };
}

function randomId(len = 10) {
  const chars = "abcdefghijklmnopqrstuvwxyz0123456789";
  let out = "";
  const bytes = new Uint8Array(len);
  crypto.getRandomValues(bytes);
  for (let i = 0; i < len; i++) out += chars[bytes[i] % chars.length];
  return out;
}

export default {
  async fetch(request, env) {
    const url = new URL(request.url);
    const path = url.pathname.replace(/\/+$/, "");
    const origin = request.headers.get("Origin") || "";
    const CORS = corsHeaders(origin);

    // CORS preflight
    if (request.method === "OPTIONS") {
      return new Response(null, { status: 204, headers: CORS });
    }

    // Health check
    if (request.method === "GET" && (path === "" || path === "/")) {
      return json(
        { ok: true, service: "playlinks-api", time: new Date().toISOString() },
        200,
        CORS
      );
    }

    // --------------------
    // GET /stats
    // --------------------
    if (request.method === "GET" && path === "/stats") {
      const s = await env.DB.prepare(
        `SELECT value FROM stats WHERE key = 'total_passes'`
      ).first();

      return json(
        { ok: true, totalPasses: Number(s?.value || 0) },
        200,
        CORS
      );
    }

    // -----------------------------------------
    // POST /game/create  body: { type?, hours? }
    // -----------------------------------------
    if (request.method === "POST" && path === "/game/create") {
      let body = {};
      try {
        body = await request.json();
      } catch {}

      const type = String(body.type || "hotpotato").toLowerCase();
      const hours = Number(body.hours ?? 24);
      const now = Date.now();
      const expiresAt = now + Math.max(1, hours) * 60 * 60 * 1000;

      const id = randomId(10);
      const token = randomId(12);

      await env.DB.prepare(
        `INSERT INTO games (id, type, created_at, expires_at, hop_count, pass_token)
         VALUES (?, ?, ?, ?, 0, ?)`
      )
        .bind(id, type, now, expiresAt, token)
        .run();

      const playUrl = `https://playlinks.games/g.html?g=${id}&t=${token}`;

      return json(
        { ok: true, id, type, createdAt: now, expiresAt, url: playUrl },
        200,
        CORS
      );
    }

    // ---------------------------------------------------
    // GET /game/:id/status?holderId=...
    // (Needed by g.html refresh/timer)
    // ---------------------------------------------------
    const statusMatch = path.match(/^\/game\/([a-z0-9]+)\/status$/i);
    if (request.method === "GET" && statusMatch) {
      const id = statusMatch[1];
      const holderId = String(url.searchParams.get("holderId") || "");

      if (!holderId || holderId.length < 6) {
        return json({ ok: false, error: "missing_holderId" }, 400, CORS);
      }

      const row = await env.DB.prepare(
        `SELECT id, expires_at, hop_count, last_holder
         FROM games WHERE id = ?`
      ).bind(id).first();

      if (!row) return json({ ok: false, error: "not_found" }, 404, CORS);

      const now = Date.now();
      const expired = now >= row.expires_at;

      return json(
        {
          ok: true,
          id,
          expired,
          expiresAt: row.expires_at,
          hopCount: row.hop_count,
          youHold: row.last_holder === holderId && !!row.last_holder,
        },
        200,
        CORS
      );
    }

    // ---------------------------------------------------
    // POST /game/:id/claim  body: { holderId, token }
    // Token must match current pass_token.
    // Does NOT increment hop_count.
    // ---------------------------------------------------
    const claimMatch = path.match(/^\/game\/([a-z0-9]+)\/claim$/i);
    if (request.method === "POST" && claimMatch) {
      const id = claimMatch[1];

      let body = {};
      try {
        body = await request.json();
      } catch {}

      const holderId = String(body.holderId || "");
      const token = String(body.token || "");

      if (!holderId || holderId.length < 6) {
        return json({ ok: false, error: "missing_holderId" }, 400, CORS);
      }
      if (!token) {
        return json({ ok: false, error: "missing_token" }, 400, CORS);
      }

      const row = await env.DB.prepare(
        `SELECT id, type, created_at, expires_at, hop_count, last_holder, pass_token
         FROM games WHERE id = ?`
      )
        .bind(id)
        .first();

      if (!row) return json({ ok: false, error: "not_found" }, 404, CORS);

      const now = Date.now();
      const expired = now >= row.expires_at;

      if (expired) {
        return json(
          {
            ok: true,
            id,
            expired: true,
            hopCount: row.hop_count,
            youWin: row.last_holder === holderId && !!row.last_holder,
          },
          200,
          CORS
        );
      }

      // Old link (token rotated) => stale; do not change holder
      if (token !== row.pass_token) {
        return json(
          {
            ok: true,
            id,
            expired: false,
            stale: true,
            hopCount: row.hop_count,
            expiresAt: row.expires_at,
            youHold: row.last_holder === holderId,
          },
          200,
          CORS
        );
      }

      // Valid token => claim holder (no hop increment)
      await env.DB.prepare(
        `UPDATE games SET last_holder = ?, last_claim_at = ? WHERE id = ?`
      )
        .bind(holderId, now, id)
        .run();

      const updated = await env.DB.prepare(
        `SELECT expires_at, hop_count, last_holder FROM games WHERE id = ?`
      )
        .bind(id)
        .first();

      return json(
        {
          ok: true,
          id,
          expired: false,
          stale: false,
          expiresAt: updated.expires_at,
          hopCount: updated.hop_count,
          youHold: updated.last_holder === holderId,
        },
        200,
        CORS
      );
    }

    // ---------------------------------------------------
    // POST /game/:id/pass  body: { holderId }
    // Only current holder can pass.
    // Rotates pass_token + increments hop_count.
    // Returns new URL with new token.
    // ---------------------------------------------------
    const passMatch = path.match(/^\/game\/([a-z0-9]+)\/pass$/i);
    if (request.method === "POST" && passMatch) {
      const id = passMatch[1];

      let body = {};
      try {
        body = await request.json();
      } catch {}

      const holderId = String(body.holderId || "");
      if (!holderId || holderId.length < 6) {
        return json({ ok: false, error: "missing_holderId" }, 400, CORS);
      }

      const row = await env.DB.prepare(
        `SELECT id, expires_at, hop_count, last_holder
         FROM games WHERE id = ?`
      )
        .bind(id)
        .first();

      if (!row) return json({ ok: false, error: "not_found" }, 404, CORS);

      const now = Date.now();
      const expired = now >= row.expires_at;
      if (expired) {
        return json(
          { ok: true, id, expired: true, hopCount: row.hop_count },
          200,
          CORS
        );
      }

      if (row.last_holder !== holderId) {
        return json({ ok: false, error: "not_holder" }, 403, CORS);
      }

      const newToken = randomId(12);

      await env.DB.prepare(
        `UPDATE games
         SET pass_token = ?, hop_count = hop_count + 1
         WHERE id = ?`
      )
        .bind(newToken, id)
        .run();

      // Increment global counter
      await env.DB.prepare(
        `UPDATE stats SET value = value + 1 WHERE key = 'total_passes'`
      ).run();

      const updated = await env.DB.prepare(
        `SELECT hop_count, expires_at FROM games WHERE id = ?`
      )
        .bind(id)
        .first();

      const newUrl = `https://playlinks.games/g.html?g=${id}&t=${newToken}`;

      return json(
        {
          ok: true,
          id,
          expired: false,
          hopCount: updated.hop_count,
          expiresAt: updated.expires_at,
          url: newUrl,
        },
        200,
        CORS
      );
    }

    // ---------------------------------------------------
    // GET /game/:id/messages?limit=...
    // ---------------------------------------------------
    const msgsGetMatch = path.match(/^\/game\/([a-z0-9]+)\/messages$/i);
    if (request.method === "GET" && msgsGetMatch) {
      const id = msgsGetMatch[1];
      const limit = Math.min(50, Math.max(1, Number(url.searchParams.get("limit") || 12)));

      const row = await env.DB.prepare(
        `SELECT id, expires_at FROM games WHERE id = ?`
      ).bind(id).first();

      if (!row) return json({ ok: false, error: "not_found" }, 404, CORS);

      const items = await env.DB.prepare(
        `SELECT id, created_at, author_holder, body
         FROM messages
         WHERE game_id = ?
         ORDER BY created_at DESC
         LIMIT ?`
      ).bind(id, limit).all();

      return json({ ok: true, messages: items.results || [] }, 200, CORS);
    }

    // ---------------------------------------------------
    // POST /game/:id/message  body: { holderId, body }
    // ---------------------------------------------------
    const msgPostMatch = path.match(/^\/game\/([a-z0-9]+)\/message$/i);
    if (request.method === "POST" && msgPostMatch) {
      const id = msgPostMatch[1];

      let body = {};
      try { body = await request.json(); } catch {}

      const holderId = String(body.holderId || "");
      const text = String(body.body || "").trim();

      if (!holderId || holderId.length < 6) {
        return json({ ok: false, error: "missing_holderId" }, 400, CORS);
      }
      if (!text) {
        return json({ ok: false, error: "empty_message" }, 400, CORS);
      }
      if (text.length > 120) {
        return json({ ok: false, error: "message_too_long" }, 400, CORS);
      }

      const game = await env.DB.prepare(
        `SELECT expires_at FROM games WHERE id = ?`
      ).bind(id).first();

      if (!game) return json({ ok: false, error: "not_found" }, 404, CORS);

      const now = Date.now();
      if (now >= game.expires_at) {
        return json({ ok: false, error: "expired" }, 400, CORS);
      }

      const mid = randomId(12);

      await env.DB.prepare(
        `INSERT INTO messages (id, game_id, created_at, author_holder, body, payment_status)
         VALUES (?, ?, ?, ?, ?, ?)`
      ).bind(mid, id, now, holderId, text, "free").run();

      return json({ ok: true, id: mid, createdAt: now }, 200, CORS);
    }

    // ---------------------------------------------------
    // POST /game/:id/cure  body: { holderId }
    // Anyone can "cure" (works even on stale links).
    // Increments hop_count + global total_passes.
    // DOES NOT change holder (non-serious, cannot stop chain).
    // ---------------------------------------------------
    const cureMatch = path.match(/^\/game\/([a-z0-9]+)\/cure$/i);
    if (request.method === "POST" && cureMatch) {
      const id = cureMatch[1];

      let body = {};
      try { body = await request.json(); } catch {}

      const holderId = String(body.holderId || "");
      if (!holderId || holderId.length < 6) {
        return json({ ok: false, error: "missing_holderId" }, 400, CORS);
      }

      const row = await env.DB.prepare(
        `SELECT expires_at, hop_count FROM games WHERE id = ?`
      ).bind(id).first();

      if (!row) return json({ ok: false, error: "not_found" }, 404, CORS);

      const now = Date.now();
      if (now >= row.expires_at) {
        return json({ ok: true, id, expired: true, hopCount: row.hop_count }, 200, CORS);
      }

      await env.DB.prepare(
        `UPDATE games SET hop_count = hop_count + 1 WHERE id = ?`
      ).bind(id).run();

      await env.DB.prepare(
        `UPDATE stats SET value = value + 1 WHERE key = 'total_passes'`
      ).run();

      const updated = await env.DB.prepare(
        `SELECT hop_count, expires_at FROM games WHERE id = ?`
      ).bind(id).first();

      return json({
        ok: true,
        id,
        expired: false,
        hopCount: updated.hop_count,
        expiresAt: updated.expires_at
      }, 200, CORS);
    }

    return json({ ok: false, error: "not_found", path }, 404, CORS);
  },
};
