<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover"
    />
    <title>Hot Potato ‚Ä¢ PlayLinks</title>
    <style>
      :root {
        --bg: #070713;
        --panel: rgba(255, 255, 255, 0.06);
        --text: rgba(255, 255, 255, 0.92);
        --muted: rgba(255, 255, 255, 0.58);
        --neon1: #00f5ff;
        --neon2: #ff2bd6;
        --neon3: #b6ff3b;
        --danger: #ff4d4d;
        --shadow: 0 0 34px rgba(0, 245, 255, 0.14);
      }

      * { box-sizing: border-box; }
      html, body { height: 100%; }
      body {
        margin: 0;
        background: radial-gradient(1200px 800px at 25% 10%, rgba(255, 43, 214, 0.12), transparent 55%),
                    radial-gradient(1000px 700px at 80% 25%, rgba(0, 245, 255, 0.12), transparent 55%),
                    radial-gradient(900px 600px at 50% 100%, rgba(182, 255, 59, 0.08), transparent 55%),
                    var(--bg);
        color: var(--text);
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
        overflow-x: hidden;
      }

      /* Mobile-first screen */
      .screen {
        max-width: 440px;
        margin: 0 auto;
        padding: 18px 16px 22px;
        min-height: 100dvh;
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .topbar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding-top: 6px;
      }
      .topbar .brand {
        font-size: 14px;
        letter-spacing: 1px;
        opacity: 0.85;
      }
      .pill {
        font-size: 11px;
        color: rgba(255,255,255,0.72);
        border: 1px solid rgba(255,255,255,0.10);
        background: rgba(255,255,255,0.05);
        padding: 7px 10px;
        border-radius: 999px;
      }

      .card {
        background: linear-gradient(180deg, rgba(255,255,255,0.07), rgba(255,255,255,0.04));
        border: 1px solid rgba(255,255,255,0.10);
        border-radius: 18px;
        padding: 14px;
        box-shadow: var(--shadow);
        backdrop-filter: blur(10px);
      }

      .title {
        font-size: 22px;
        margin: 2px 0 0;
        letter-spacing: 0.2px;
      }
      .subtitle {
        margin: 8px 0 0;
        color: var(--muted);
        font-size: 13px;
        line-height: 1.35;
      }

      /* Mascot + motion */
      .mascotWrap {
        display: grid;
        place-items: center;
        margin-top: 6px;
      }
      .mascot {
        width: 168px;
        height: 168px;
        filter: drop-shadow(0 0 18px rgba(255, 43, 214, 0.25));
        animation: floaty 3.4s ease-in-out infinite;
      }
      @keyframes floaty {
        0% { transform: translateY(0px) rotate(-2deg); }
        50% { transform: translateY(-8px) rotate(2deg); }
        100% { transform: translateY(0px) rotate(-2deg); }
      }
      .flamePulse {
        transform-origin: 60px 24px;
        animation: flame 0.65s ease-in-out infinite;
      }
      @keyframes flame {
        0% { opacity: 0.85; transform: scale(0.98); }
        50% { opacity: 1; transform: scale(1.04); }
        100% { opacity: 0.85; transform: scale(0.98); }
      }

      /* Big neon timer + passes */
      .neonStatRow {
        display: flex;
        gap: 10px;
        margin-top: 10px;
      }
      .stat {
        flex: 1;
        padding: 12px 12px;
        border-radius: 16px;
        border: 1px solid rgba(255,255,255,0.10);
        background: rgba(0,0,0,0.22);
      }
      .statLabel {
        font-size: 11px;
        color: rgba(255,255,255,0.55);
        letter-spacing: 0.7px;
      }
      .timerValue {
        margin-top: 6px;
        font-weight: 900;
        font-size: 22px;
        letter-spacing: 0.2px;
        color: var(--neon1);
        text-shadow: 0 0 18px rgba(0,245,255,0.25);
      }
      .passesValue {
        margin-top: 6px;
        font-weight: 900;
        font-size: 22px;
        color: var(--neon2);
        text-shadow: 0 0 18px rgba(255,43,214,0.22);
      }

      /* Buttons */
      .btn {
        width: 100%;
        border: 0;
        border-radius: 18px;
        padding: 16px 14px;
        font-size: 16px;
        font-weight: 800;
        color: #061018;
        background: linear-gradient(90deg, var(--neon1), var(--neon2));
        box-shadow: 0 0 20px rgba(0,245,255,0.20);
        cursor: pointer;
        -webkit-tap-highlight-color: transparent;
      }
      .btn:active { transform: translateY(1px); }
      .btnSecondary {
        width: 100%;
        border-radius: 18px;
        padding: 14px 14px;
        font-size: 14px;
        font-weight: 800;
        color: rgba(255,255,255,0.86);
        background: rgba(255,255,255,0.06);
        border: 1px solid rgba(255,255,255,0.12);
        cursor: pointer;
        -webkit-tap-highlight-color: transparent;
      }
      .btn:disabled, .btnSecondary:disabled { opacity: 0.5; cursor: not-allowed; }

      .smallNote {
        margin-top: 10px;
        color: rgba(255,255,255,0.56);
        font-size: 12px;
        line-height: 1.35;
      }

      /* subtle reserved area (future use) */
      .quietSlot {
        margin-top: auto;
        height: 58px;
        border-radius: 14px;
        background: rgba(0,0,0,0.16);
        border: 1px solid rgba(255,255,255,0.06);
        opacity: 0.55;
      }

      /* IG in-app hint */
      .igHint {
        margin-top: 8px;
        font-size: 11px;
        color: rgba(255,255,255,0.50);
        text-align: center;
      }
      .toast {
        position: fixed;
        left: 50%;
        bottom: 18px;
        transform: translateX(-50%);
        background: rgba(0,0,0,0.72);
        border: 1px solid rgba(255,255,255,0.12);
        color: rgba(255,255,255,0.92);
        padding: 10px 12px;
        border-radius: 14px;
        font-size: 12px;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.2s ease;
        max-width: 92vw;
        text-align: center;
        z-index: 50;
      }
      .toast.show { opacity: 1; }

      /* --- New: Global + Rank + 8-bit map --- */
      .metaRow {
        display: flex;
        gap: 10px;
        margin-top: 10px;
      }
      .metaCard {
        flex: 1;
        padding: 12px;
        border-radius: 16px;
        border: 1px solid rgba(255,255,255,0.10);
        background: rgba(0,0,0,0.22);
      }
      .metaTop {
        display: flex;
        align-items: baseline;
        justify-content: space-between;
        gap: 8px;
      }
      .metaLabel {
        font-size: 11px;
        color: rgba(255,255,255,0.55);
        letter-spacing: 0.7px;
      }
      .metaValue {
        font-weight: 900;
        font-size: 16px;
        color: rgba(255,255,255,0.92);
      }
      .rankValue {
        font-weight: 900;
        font-size: 14px;
        color: var(--neon3);
        text-shadow: 0 0 14px rgba(182,255,59,0.16);
      }
      .metaSub {
        margin-top: 6px;
        font-size: 12px;
        color: rgba(255,255,255,0.56);
        line-height: 1.25;
      }

      .mapWrap {
        margin-top: 10px;
        padding: 12px;
        border-radius: 16px;
        border: 1px solid rgba(255,255,255,0.10);
        background: rgba(0,0,0,0.18);
        overflow: hidden;
      }
      .mapHeader {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
      }
      .mapTitle {
        font-size: 11px;
        color: rgba(255,255,255,0.55);
        letter-spacing: 0.7px;
      }
      .mapCount {
        font-size: 11px;
        color: rgba(255,255,255,0.70);
      }
      .mapGrid {
        margin-top: 10px;
        display: grid;
        grid-template-columns: repeat(20, 1fr);
        gap: 2px;
        image-rendering: pixelated;
      }
      .px {
        aspect-ratio: 1 / 1;
        border-radius: 2px;
        background: rgba(255,255,255,0.06);
      }
      .land { background: rgba(0,245,255,0.10); }
      .potatoDot { background: rgba(255,43,214,0.75); box-shadow: 0 0 10px rgba(255,43,214,0.30); }
      .hotDot { background: rgba(182,255,59,0.78); box-shadow: 0 0 10px rgba(182,255,59,0.25); }

      /* Confetti canvas */
      #confetti {
        position: fixed;
        inset: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 40;
      }
    </style>
  </head>

  <body>
    <canvas id="confetti"></canvas>

    <div class="screen">
      <div class="topbar">
        <div class="brand">PLAYLINKS</div>
        <div class="pill" id="gidPill">ID: ‚Ä¶</div>
      </div>

      <div class="card">
        <div class="title" id="title">Loading‚Ä¶</div>
        <div class="subtitle" id="main">Opening‚Ä¶</div>

        <div class="mascotWrap">
          <!-- Cute potato mascot (inline SVG so no assets needed) -->
          <svg class="mascot" viewBox="0 0 120 120" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
            <defs>
              <radialGradient id="pSkin2" cx="35%" cy="30%" r="70%">
                <stop offset="0" stop-color="#ffd6a6"/>
                <stop offset="1" stop-color="#c98a3a"/>
              </radialGradient>
              <linearGradient id="flame2" x1="0" x2="1">
                <stop offset="0" stop-color="#00f5ff"/>
                <stop offset="0.5" stop-color="#ff2bd6"/>
                <stop offset="1" stop-color="#ffcc33"/>
              </linearGradient>
            </defs>

            <!-- flame -->
            <g class="flamePulse">
              <path d="M60 8 C49 25,78 30,58 47 C45 60,55 72,60 76 C70 69,79 60,74 47 C69 34,86 29,78 14 C72 4,64 4,60 8Z"
                    fill="url(#flame2)" opacity="0.95"/>
              <path d="M60 18 C55 28,70 30,60 41 C52 50,56 57,60 60 C66 55,68 49,66 41 C64 33,72 30,69 22 C67 18,62 16,60 18Z"
                    fill="#ffffff" opacity="0.18"/>
            </g>

            <!-- potato -->
            <path d="M23 63 C22 35,47 22,70 27 C94 31,105 50,96 74 C87 99,57 106,38 95 C28 88,24 78,23 63Z"
                  fill="url(#pSkin2)" stroke="rgba(255,255,255,0.10)" stroke-width="2"/>

            <!-- speckles -->
            <circle cx="39" cy="58" r="2" fill="rgba(0,0,0,0.12)"/>
            <circle cx="82" cy="55" r="2" fill="rgba(0,0,0,0.12)"/>
            <circle cx="70" cy="86" r="2" fill="rgba(0,0,0,0.10)"/>

            <!-- face -->
            <circle cx="50" cy="67" r="5" fill="rgba(0,0,0,0.55)"/>
            <circle cx="74" cy="67" r="5" fill="rgba(0,0,0,0.55)"/>
            <path d="M53 79 C60 88,71 88,78 79" stroke="rgba(0,0,0,0.45)" stroke-width="5" stroke-linecap="round" fill="none"/>
            <circle cx="43" cy="76" r="6" fill="#ff2bd6" opacity="0.18"/>
            <circle cx="84" cy="76" r="6" fill="#00f5ff" opacity="0.18"/>
          </svg>
        </div>

        <div class="neonStatRow">
          <div class="stat">
            <div class="statLabel">TIMER</div>
            <div class="timerValue" id="timer">‚Äî</div>
          </div>
          <div class="stat">
            <div class="statLabel">PASSES</div>
            <div class="passesValue" id="passes">‚Äî</div>
          </div>
        </div>

        <!-- New: global + rank -->
        <div class="metaRow">
          <div class="metaCard">
            <div class="metaTop">
              <div class="metaLabel">GLOBAL PASSES</div>
              <div class="metaValue" id="globalPasses">‚Äî</div>
            </div>
            <div class="metaSub" id="globalSub">Across all games.</div>
          </div>
          <div class="metaCard">
            <div class="metaTop">
              <div class="metaLabel">YOUR TITLE</div>
              <div class="rankValue" id="rankTitle">‚Äî</div>
            </div>
            <div class="metaSub" id="rankSub">Earn titles by passing.</div>
          </div>
        </div>

        <!-- New: 8-bit map -->
        <div class="mapWrap" id="mapWrap" style="display:none">
          <div class="mapHeader">
            <div class="mapTitle">üåç LIVE POTATO MAP</div>
            <div class="mapCount" id="mapCount">‚Äî</div>
          </div>
          <div class="mapGrid" id="mapGrid" aria-hidden="true"></div>
        </div>

        <div style="height: 12px"></div>

        <button class="btn" id="passBtn">üîÅ Pass it now</button>
        <div style="height: 10px"></div>
        <button class="btnSecondary" id="homeBtn">üè† Main menu</button>

        <div class="smallNote" id="note"></div>
        <div class="igHint" id="igHint"></div>
      </div>

      <!-- subtle reserved area (future use) -->
      <div class="quietSlot" aria-hidden="true"></div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
      const API = "https://api.playlinks.games";
      const params = new URLSearchParams(location.search);
      const gameId = params.get("g");
      const token = params.get("t");

      const gidPill = document.getElementById("gidPill");
      const titleEl = document.getElementById("title");
      const mainEl = document.getElementById("main");
      const timerEl = document.getElementById("timer");
      const passesEl = document.getElementById("passes");
      const noteEl = document.getElementById("note");
      const passBtn = document.getElementById("passBtn");
      const homeBtn = document.getElementById("homeBtn");
      const igHintEl = document.getElementById("igHint");
      const toastEl = document.getElementById("toast");

      // New UI refs
      const globalPassesEl = document.getElementById("globalPasses");
      const globalSubEl = document.getElementById("globalSub");
      const rankTitleEl = document.getElementById("rankTitle");
      const rankSubEl = document.getElementById("rankSub");
      const mapWrapEl = document.getElementById("mapWrap");
      const mapGridEl = document.getElementById("mapGrid");
      const mapCountEl = document.getElementById("mapCount");

      gidPill.textContent = "ID: " + (gameId ? gameId : "‚Äî");

      const isInstagram = /Instagram/i.test(navigator.userAgent);
      if (isInstagram) {
        igHintEl.textContent = "Tip: IG in-app browser sometimes blocks auto-share. Copy link ‚Üí use Link sticker.";
      }

      function toast(msg) {
        toastEl.textContent = msg;
        toastEl.classList.add("show");
        setTimeout(() => toastEl.classList.remove("show"), 1400);
      }

      function getHolderId() {
        const key = "playlinks_holder_id";
        let v = localStorage.getItem(key);
        if (!v) {
          v = "h_" + Math.random().toString(36).slice(2) + Date.now().toString(36);
          localStorage.setItem(key, v);
        }
        return v;
      }

      // -------- New: participation + titles (local-only, safe) --------
      const TITLES = [
        "üëÄ Lurker", "ü•î Potato Tourist", "üî• Warm Hands", "üß§ Quick Passer", "üß© Chain Link",
        "‚ö° Speed Tapper", "ü™Ñ Lucky Hands", "üéØ Clean Pass", "üß® Chaos Spark", "ü•∑ Silent Passer",
        "üßØ Fire Manager", "üïπÔ∏è Story Gamer", "üõ°Ô∏è Chain Guardian", "üß† Mind Games", "üßä Ice Veins",
        "üöÄ Viral Fuel", "üëë Chain Royalty", "üêâ Flame Keeper", "üå™Ô∏è Storm Bringer", "ü™ê Legend"
      ];

      function playedKey() { return gameId ? `played_${gameId}` : "played_"; }
      function passesKey() { return gameId ? `myPasses_${gameId}` : "myPasses_"; }

      function markPlayed() {
        if (!gameId) return;
        localStorage.setItem(playedKey(), "1");
      }

      function getMyPasses() {
        if (!gameId) return 0;
        return Number(localStorage.getItem(passesKey()) || 0);
      }

      function incMyPasses() {
        if (!gameId) return 0;
        const n = getMyPasses() + 1;
        localStorage.setItem(passesKey(), String(n));
        markPlayed();
        return n;
      }

      function updateRankUI() {
        const p = getMyPasses();
        const idx = Math.min(TITLES.length - 1, p);
        rankTitleEl.textContent = TITLES[idx];
        if (p === 0) rankSubEl.textContent = "Pass the potato to level up.";
        else if (p === 1) rankSubEl.textContent = "Nice. You‚Äôre part of the chain.";
        else rankSubEl.textContent = `You‚Äôve passed ${p} time${p === 1 ? "" : "s"} in this game.`;
      }

      updateRankUI();

      // -------- New: real global passes + map --------
      let globalPasses = null;

      async function loadStats() {
        try {
          const res = await fetch(`${API}/stats`);
          const data = await res.json();
          if (data && data.ok) {
            globalPasses = Number(data.totalPasses || 0);
            globalPassesEl.textContent = String(globalPasses);
            globalSubEl.textContent = "Real passes across all games.";
            renderMap(globalPasses);
            return;
          }
        } catch {}
        globalPassesEl.textContent = "‚Äî";
        globalSubEl.textContent = "Couldn‚Äôt load stats.";
      }

      // Pixel-map style A
      function mulberry32(a) {
        return function () {
          let t = (a += 0x6D2B79F5);
          t = Math.imul(t ^ (t >>> 15), t | 1);
          t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
          return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
        };
      }

      function hashSeed(str) {
        let h = 2166136261;
        for (let i = 0; i < str.length; i++) {
          h ^= str.charCodeAt(i);
          h = Math.imul(h, 16777619);
        }
        return h >>> 0;
      }

      function renderMap(total) {
        // Show map once we have stats
        mapWrapEl.style.display = "block";

        // 20x10 = 200 px tiles
        const W = 20;
        const H = 10;
        const tiles = W * H;

        // Simple "continent" mask by thresholding RNG (pixel-art feel)
        const seed = hashSeed(String(gameId || "x") + "_" + String(total));
        const rand = mulberry32(seed);

        // How many potatoes to show: tie to real total passes, cap to avoid clutter
        const potatoCount = Math.max(1, Math.min(30, Math.floor(total / 2) + 1));
        mapCountEl.textContent = `${potatoCount} hot potatoes spotted`;

        // Build base grid
        mapGridEl.innerHTML = "";
        const landMask = new Array(tiles).fill(false);

        for (let i = 0; i < tiles; i++) {
          // Create "blobs" of land by smoothing-ish randomness
          const r = rand();
          landMask[i] = r > 0.62; // tweak for more/less land
        }

        // Render tiles
        for (let i = 0; i < tiles; i++) {
          const d = document.createElement("div");
          d.className = "px" + (landMask[i] ? " land" : "");
          mapGridEl.appendChild(d);
        }

        // Sprinkle potatoes on land (if possible)
        const chosen = new Set();
        const tileNodes = mapGridEl.children;

        let placed = 0;
        let safety = 0;
        while (placed < potatoCount && safety < 2000) {
          safety++;
          const idx = Math.floor(rand() * tiles);
          if (!landMask[idx]) continue;
          if (chosen.has(idx)) continue;
          chosen.add(idx);

          const node = tileNodes[idx];
          node.className = "px potatoDot";
          placed++;
        }

        // Add a couple "hot" potatoes
        const hot = Math.min(3, placed);
        let hplaced = 0;
        safety = 0;
        while (hplaced < hot && safety < 500) {
          safety++;
          const idx = Math.floor(rand() * tiles);
          if (!chosen.has(idx)) continue;
          tileNodes[idx].className = "px hotDot";
          hplaced++;
        }
      }

      // -------- New: lightweight confetti --------
      const confettiCanvas = document.getElementById("confetti");
      const ctx = confettiCanvas.getContext("2d");
      function resizeConfetti() {
        confettiCanvas.width = Math.floor(window.innerWidth * devicePixelRatio);
        confettiCanvas.height = Math.floor(window.innerHeight * devicePixelRatio);
      }
      window.addEventListener("resize", resizeConfetti);
      resizeConfetti();

      function burstConfetti(intensity = 60) {
        const W = confettiCanvas.width;
        const H = confettiCanvas.height;
        const pieces = [];
        const colors = ["#00f5ff", "#ff2bd6", "#b6ff3b", "#ffcc33", "#ffffff"];

        for (let i = 0; i < intensity; i++) {
          pieces.push({
            x: W * (0.2 + Math.random() * 0.6),
            y: H * (0.15 + Math.random() * 0.15),
            vx: (Math.random() - 0.5) * W * 0.0022,
            vy: (Math.random() * -1) * H * 0.0038,
            g: H * 0.000006,
            r: (3 + Math.random() * 5) * devicePixelRatio,
            a: 1,
            c: colors[Math.floor(Math.random() * colors.length)],
            spin: (Math.random() - 0.5) * 0.25,
            rot: Math.random() * Math.PI
          });
        }

        let t = 0;
        function frame() {
          t++;
          ctx.clearRect(0, 0, W, H);
          for (const p of pieces) {
            p.vy += p.g * 60;
            p.x += p.vx * 60;
            p.y += p.vy * 60;
            p.rot += p.spin;
            p.a *= 0.985;

            if (p.a < 0.02) continue;
            ctx.save();
            ctx.globalAlpha = p.a;
            ctx.translate(p.x, p.y);
            ctx.rotate(p.rot);
            ctx.fillStyle = p.c;
            ctx.fillRect(-p.r, -p.r, p.r * 2.2, p.r * 1.2);
            ctx.restore();
          }
          if (t < 45) requestAnimationFrame(frame);
          else ctx.clearRect(0, 0, W, H);
        }
        requestAnimationFrame(frame);
      }

      // ------------------------------------------------
      // Existing game logic (kept as-is)
      // ------------------------------------------------
      let countdownTimer = null;

      function formatRemaining(ms) {
        const s = Math.max(0, Math.floor(ms / 1000));
        const hh = Math.floor(s / 3600);
        const mm = Math.floor((s % 3600) / 60);
        const ss = s % 60;
        return `${hh}h ${mm}m ${ss}s`;
      }

      function startCountdown(expiresAt, hopCount) {
        if (countdownTimer) clearInterval(countdownTimer);

        function tick() {
          const left = expiresAt - Date.now();
          passesEl.textContent = String(hopCount ?? "‚Äî");

          if (left <= 0) {
            timerEl.textContent = "00h 00m 00s";
            noteEl.textContent = "‚è≥ Ending‚Ä¶";
            clearInterval(countdownTimer);
            countdownTimer = null;
            refresh();
            return;
          }

          timerEl.textContent = formatRemaining(left);
        }

        tick();
        countdownTimer = setInterval(tick, 1000);
      }

      function showExpiredResult(youAreHolderAtEnd, hopCount) {
        titleEl.textContent = "Game over";
        passBtn.disabled = true;
        passesEl.textContent = String(hopCount ?? "‚Äî");
        timerEl.textContent = "00h 00m 00s";

        if (youAreHolderAtEnd) {
          mainEl.textContent = "üî• You got burned.";
          noteEl.textContent = `You were holding it at the end ‚Ä¢ Total passes: ${hopCount ?? "‚Äî"}`;
        } else {
          mainEl.textContent = "üòÆ‚Äçüí® You survived.";
          noteEl.textContent = `Someone else got burned ‚Ä¢ Total passes: ${hopCount ?? "‚Äî"}`;
        }
      }

      function showStaleLink() {
        titleEl.textContent = "Hot Potato";
        mainEl.textContent = "ü•î You don‚Äôt have the potato.";
        // New: make them feel part of something if they played
        const played = gameId && localStorage.getItem(playedKey()) === "1";
        noteEl.textContent = played
          ? "You were part of this chain. The potato is still moving‚Ä¶"
          : "You need the latest story link to claim it.";
        passBtn.disabled = true;
      }

      async function claim() {
        if (!gameId || !token) {
          titleEl.textContent = "Invalid link";
          mainEl.textContent = "Missing game id or token.";
          noteEl.textContent = "Ask the person who shared it to repost the latest link.";
          passBtn.disabled = true;
          return;
        }

        const holderId = getHolderId();

        const res = await fetch(`${API}/game/${gameId}/claim`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ holderId, token }),
        });

        let data = {};
        try { data = await res.json(); } catch {}

        if (!data.ok) {
          titleEl.textContent = "Error";
          mainEl.textContent = "Could not load game.";
          noteEl.textContent = data.error || "unknown_error";
          passBtn.disabled = true;
          return;
        }

        if (data.expired) {
          showExpiredResult(!!data.youWin, data.hopCount);
          return;
        }

        if (data.stale) {
          showStaleLink();
          return;
        }

        // New: mark participation + confetti
        markPlayed();
        updateRankUI();
        burstConfetti(70);

        titleEl.textContent = "Hot Potato";
        mainEl.textContent = "üî• You are holding it right now.";
        noteEl.textContent = "Pass it before the timer hits zero üòà";
        passBtn.disabled = false;

        startCountdown(data.expiresAt, data.hopCount);
      }

      async function refresh() {
        if (!gameId) return;
        const holderId = getHolderId();

        const res = await fetch(`${API}/game/${gameId}/status?holderId=${encodeURIComponent(holderId)}`);
        let data = {};
        try { data = await res.json(); } catch {}
        if (!data.ok) return;

        if (data.expired) {
          showExpiredResult(!!data.youHold, data.hopCount);
          return;
        }

        titleEl.textContent = "Hot Potato";
        if (data.youHold) {
          mainEl.textContent = "üî• You are holding it right now.";
          noteEl.textContent = "Pass it before the timer hits zero üòà";
          markPlayed();
          updateRankUI();
        } else {
          mainEl.textContent = "ü•î You don‚Äôt have the potato.";
          const played = gameId && localStorage.getItem(playedKey()) === "1";
          noteEl.textContent = played
            ? `You were part of this chain ‚Ä¢ Global passes: ${globalPasses ?? "‚Äî"}`
            : "Get the latest story link to claim it.";
        }

        passBtn.disabled = !data.youHold;
        startCountdown(data.expiresAt, data.hopCount);
      }

      async function passItNow() {
        const holderId = getHolderId();
        passBtn.disabled = true;

        const res = await fetch(`${API}/game/${gameId}/pass`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ holderId }),
        });

        let data = {};
        try { data = await res.json(); } catch {}

        if (!data.ok) {
          passBtn.disabled = false;
          toast(data.error === "not_holder" ? "You‚Äôre not the holder." : "Pass failed.");
          return;
        }

        if (data.expired) {
          showExpiredResult(true, data.hopCount);
          return;
        }

        // New: local title progress
        const my = incMyPasses();
        updateRankUI();

        // Confetti + title pop
        burstConfetti(55);
        toast(`Unlocked: ${TITLES[Math.min(TITLES.length - 1, my)]} ‚ú®`);

        const newLink = data.url;

        // Best-effort share + copy (2-in-1 feel)
        let shared = false;
        if (navigator.share) {
          try {
            await navigator.share({
              title: "Hot Potato üî•",
              text: "You‚Äôre holding it‚Ä¶ pass it üòà",
              url: newLink,
            });
            shared = true;
          } catch {}
        }

        try {
          await navigator.clipboard.writeText(newLink);
          toast(shared ? "Shared + copied ‚úÖ" : "New link copied ‚úÖ");
          noteEl.textContent = shared
            ? `Nice. Total passes: ${data.hopCount}`
            : `Copied. Post to IG Story (Link sticker) ‚Ä¢ Total passes: ${data.hopCount}`;
        } catch {
          noteEl.textContent = "Couldn‚Äôt auto-copy. Copy the link manually.";
        }

        // Update current URL token so this tab stays ‚Äúlatest‚Äù
        const newUrlObj = new URL(newLink);
        const newToken = newUrlObj.searchParams.get("t");
        const cur = new URL(location.href);
        cur.searchParams.set("t", newToken);
        history.replaceState({}, "", cur.toString());

        // Stats might have incremented ‚Äî refresh global count (best-effort)
        loadStats();

        await claim();
      }

      homeBtn.onclick = () => {
        window.location.href = "https://playlinks.games/";
      };

      passBtn.onclick = passItNow;

      // Start: load stats + claim
      loadStats();
      claim();
    </script>
  </body>
</html>
